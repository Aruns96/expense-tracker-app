<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
   
    
</style>
</head>
<body>
    
<form onsubmit="saveToLocal(event)">
    <label for="amount">Choose Expense Amount</label>
    <input type="number" name="amount" id="amount" >
    <label for="descripiton">Choose Expense descripiton</label>
    <input type="text" name="descripiton" id="descripiton"  >
    <label for="category">Choose a Category</label>
    <select name="category" id="category">
        <option value="petrol">petrol</option>
        <option value="food">food</option>
        <option value="movie">movie</option>
        <option value="misc">misc</option>
    </select>
    <button>Add Expense</button>
   
   
    

</form>
<button id="btnrazrpy">Buy premium</button>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<h1>Expenses</h1>
<ul id="listItems"></ul>
<div id="premiumUser"></div>
<ul id="leaderboard"></ul>

 
 
 <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>

 
 <script >
   function saveToLocal(event){
    event.preventDefault();
    const amount = event.target.amount.value;
    const descripiton= event.target.descripiton.value;
    const category = event.target.category.value;
   

   const obj = {
    amount,
    descripiton,
    category
   }
  
   const token = localStorage.getItem("token");
    axios.post("http://localhost:3000/expense/addExpense" ,obj,{headers:{"Authorization":token}})
    .then(res =>{
        console.log(res);
        showItems(res.data.newExpense)
        

    })
    .catch(e => {
        console.log(e)

        document.body.innerHTML=document.body.innerHTML + `<h3>${e}</h3>`
    })
    event.target.amount.value="";
    event.target.descripiton.value="";
    event.target.category.value="";


   }
  function showItems(expense){
    const parentNode = document.getElementById("listItems");
    const child = document.createElement("li");
    child.id = expense.id;
    child.innerText = expense.amount + "-" + expense.descripiton + "-" + expense.category;
    const del = document.createElement("button");
    del.innerText = "delete";
    del.onclick = ()=>deleteExpense(expense.id);

    child.appendChild(del);
    parentNode.appendChild(child);



  }
  function deleteExpense(id){
    const token = localStorage.getItem("token");
    axios.delete(`http://localhost:3000/expense/delete-expense/${id}`,{headers:{"Authorization":token}}).then(res=>{
        
        removeExpense(id);
     }).catch(e=>{console.log(e)
    showError(e)});
  }
function showError(error){
    document.body.innerHTML += `<div>${error}</div>`
}
  function removeExpense(id){
     const parentNode = document.getElementById("listItems");
     const nodeToDelete = document.getElementById(id);
     if(nodeToDelete){
         parentNode.removeChild(nodeToDelete);
     }
 
    }

    document.addEventListener("DOMContentLoaded",()=>{
        const token = localStorage.getItem("token");
        const decoded = parseJwt(token);
        console.log(decoded)
        if(decoded.ispremiumuser){
            premiumUser();
            showLeaderBoard();
        }
         axios.get("http://localhost:3000/expense/get-expense",{headers:{"Authorization":token}}).then(res =>{
            for(let i=0; i< res.data.allExpense.length ;i++){
             showItems(res.data.allExpense[i]);
            }
            
         })
         .catch(e=>console.log(e))
     })
    function premiumUser(){
        document.getElementById("btnrazrpy").style.visibility = "hidden";
        const p = document.getElementById("premiumUser");
        p.innerHTML = "you are now a premium user";

    }
    function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
}
     document.getElementById("btnrazrpy").onclick = async function(e){
        
        const token = localStorage.getItem("token");
        
         
        const response = await axios.get("http://localhost:3000/purchase/premium", {
    headers: { "Authorization": token },
  });
        
        console.log(response);
        var options = {
            "key":response.data.key_id,
            "order_id":response.data.order.id,
            "handler": async function(response){


              const res =   await axios.post(
        "http://localhost:3000/purchase/updatetransaction",
        {
          order_id: options.order_id,
          payment_id: response.razorpay_payment_id,
        },
        { headers: { "Authorization": token } }
      );

               

                alert("You are a premium user now");
                premiumUser();
                
                localStorage.setItem("token",res.data.token);
                showLeaderBoard();
            }

        };  
       
        const rzp1 = new Razorpay(options);
        rzp1.open();
        e.preventDefault();
        rzp1.on("payment.failed",function(response){
            console.log(response);
            alert("Something went wrong");
        })
       

     }

     function showLeaderBoard(){
        const input = document.createElement("input");
        input.type = "button";
        input.value = "show leaderboard";
        const div = document.getElementById("premiumUser");
         div.appendChild(input);
        input.onclick = async()=>{
            const token = localStorage.getItem("token");
            const userLeadBoardArray = await axios.get("http://localhost:3000/premium/showleaderboard", {
    headers: { "Authorization": token },
  });
  console.log(userLeadBoardArray)
      var leaderboardElement = document.getElementById("leaderboard");
      leaderboardElement.innerHTML += "<h1> Leader Board </h1>";

      userLeadBoardArray.data.forEach(userDetail => {
        
        leaderboardElement.innerHTML += `<li>Name:${userDetail.name}--Total Expense:${userDetail.totol_cost}</li>`
      });

        }

     }


 </script> 
</body>
</html>